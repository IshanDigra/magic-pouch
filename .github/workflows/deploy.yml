name: build-and-deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write
  checks: write
  pull-requests: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      config-valid: ${{ steps.validate-config.outputs.valid }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate config.json
        id: validate-config
        run: |
          echo "Starting config validation..."
          
          # Check if config.json exists
          if [ ! -f "config.json" ]; then
            echo "âŒ config.json not found"
            exit 1
          fi
          
          echo "âœ“ config.json found"
          
          # Validate JSON syntax
          if ! python3 -m json.tool config.json > /dev/null 2>&1; then
            echo "âŒ config.json has invalid JSON syntax"
            exit 1
          fi
          
          echo "âœ“ config.json has valid JSON syntax"
          
          # Check required Firebase keys
          echo "Checking required Firebase keys..."
          python3 << 'EOF'
import json
import sys

with open('config.json', 'r') as f:
    config = json.load(f)

required_keys = ['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId']
for key in required_keys:
    if key not in config:
        print(f"âŒ Missing required key: {key}")
        sys.exit(1)
    print(f"âœ“ Found {key}")

print("âœ“ All Firebase keys present")

# Check firewall config
if 'firewall' in config:
    print(f"âœ“ Firewall config detected")
    print(f"âœ“ Firewall enabled: {config['firewall'].get('enabled', True)}")
else:
    print("âš  Firewall config not found (optional)")

print("\nâœ“âœ“âœ“ Config validation PASSED âœ“âœ“âœ“")
EOF
          
          echo "valid=true" >> $GITHUB_OUTPUT

  build:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 10
    if: needs.validate.outputs.config-valid == 'true'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Build artifact
        run: |
          echo "ğŸ“¦ Preparing deployment artifact..."
          echo "âœ“ All static files ready"
          echo "âœ“ Firebase config validated"
          echo "âœ“ Security headers configured"

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './'
          retention-days: 30

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Deployment Status
        run: |
          echo "âœ… Deployment Successful!"
          echo "ğŸ“± Live URL: https://IshanDigra.github.io/magic-pouch"
          echo "ğŸ”’ Firewall enabled and configured"
          echo "ğŸ›¡ï¸  Security headers active"
